<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediBooking - Admin Panel</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #0ea5e9;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --sidebar-bg: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
      --sidebar-width: 280px;
      --sidebar-width-collapsed: 80px;
      --bg-color: #f1f5f9;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --text-dark: #1e293b;
      --text-light: #64748b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      font-family: 'Inter', sans-serif;
      color: var(--text-dark);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(14, 165, 233, 0.03) 0%, transparent 50%);
      z-index: -1;
    }

    /* --- Enhanced Sidebar Styling --- */
    .sidebar {
      height: 100vh;
      background: var(--sidebar-bg);
      color: white;
      padding-top: 0;
      position: fixed;
      width: var(--sidebar-width);
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      white-space: nowrap;
      overflow: hidden;
      box-shadow: 4px 0 30px rgba(0, 0, 0, 0.15);
    }

    /* Sidebar glow effect */
    .sidebar::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 1px;
      height: 100%;
      background: linear-gradient(180deg,
          rgba(99, 102, 241, 0.5) 0%,
          rgba(14, 165, 233, 0.3) 50%,
          rgba(99, 102, 241, 0.5) 100%);
    }

    .sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
    }

    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .link-text {
      display: none;
      opacity: 0;
    }

    .sidebar.collapsed .sidebar-header {
      justify-content: center;
      padding: 20px 15px;
    }

    .sidebar-header {
      padding: 25px 25px 20px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 80px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
    }

    .logo-text {
      font-weight: 700;
      font-size: 20px;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .logo-text i {
      -webkit-text-fill-color: var(--primary);
      margin-right: 8px;
    }

    .sidebar a {
      color: #94a3b8;
      text-decoration: none;
      display: flex;
      align-items: center;
      padding: 16px 25px;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      height: 58px;
      position: relative;
      margin: 4px 12px;
      border-radius: 12px;
    }

    .sidebar.collapsed a {
      justify-content: center;
      padding: 16px 0;
      margin: 4px 8px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(99, 102, 241, 0.15);
      color: white;
      border-left-color: transparent;
    }

    .sidebar a.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .sidebar a.active i {
      color: white;
    }

    .sidebar i {
      font-size: 1.3rem;
      min-width: 35px;
      transition: transform 0.2s ease;
    }

    .sidebar a:hover i {
      transform: scale(1.1);
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    /* --- Main Content --- */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 35px 40px;
      transition: margin-left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      min-height: 100vh;
    }

    .main-content.expanded {
      margin-left: var(--sidebar-width-collapsed);
    }

    /* Page Header */
    .main-content h2 {
      font-weight: 800;
      font-size: 28px;
      color: var(--text-dark);
      letter-spacing: -0.5px;
    }

    .main-content>div:first-child p {
      color: var(--text-light);
      font-size: 15px;
    }

    /* Enhanced Stat Cards */
    .stat-card {
      border: none;
      border-radius: 20px;
      padding: 28px;
      color: white;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.18);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -20%;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
    }

    .bg-gradient-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #818cf8 100%);
    }

    .bg-gradient-success {
      background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
    }

    .bg-gradient-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
    }

    .stat-card h3 {
      font-size: 3rem;
      font-weight: 800;
      margin: 0;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .stat-card p {
      margin: 8px 0 0;
      font-size: 14px;
      font-weight: 600;
      opacity: 0.9;
      position: relative;
      z-index: 1;
      letter-spacing: 0.3px;
    }

    /* Enhanced Table Card */
    .table-card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .table-card h5 {
      font-weight: 700;
      font-size: 18px;
      color: var(--text-dark);
    }

    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      color: var(--text-light);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.8px;
      padding: 16px 14px;
      border: none;
      white-space: nowrap;
    }

    .table thead th:first-child {
      border-radius: 12px 0 0 12px;
    }

    .table thead th:last-child {
      border-radius: 0 12px 12px 0;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background: rgba(99, 102, 241, 0.04);
    }

    .table tbody td {
      padding: 18px 14px;
      vertical-align: middle;
      font-size: 0.9rem;
      border-bottom: 1px solid #f1f5f9;
    }

    /* Enhanced Status Badges */
    .status-badge {
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .status-Confirmed {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #166534;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    .status-Cancelled {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }

    .status-Pending {
      background: linear-gradient(135deg, #fef9c3, #fef08a);
      color: #854d0e;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
    }

    .status-Processing {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .status-Failed {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #b91c1c;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }

    .status-Manual {
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      color: #075985;
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
    }

    /* Urgent Row Styling */
    .row-urgent {
      background: linear-gradient(90deg, #fff7ed, #ffedd5) !important;
      border-left: 4px solid var(--warning);
    }

    .badge-urgent {
      background: linear-gradient(135deg, #c2410c, #ea580c);
      color: white;
      font-size: 0.7rem;
      padding: 5px 10px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      animation: pulse 2s infinite;
      box-shadow: 0 2px 10px rgba(234, 88, 12, 0.3);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.85;
        transform: scale(1.02);
      }
    }

    /* Enhanced Buttons */
    .btn {
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #059669);
      border: none;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      border: none;
    }

    .btn-outline-danger {
      border-width: 2px;
    }

    .btn-outline-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.25);
    }

    .btn-outline-secondary {
      border-width: 2px;
      color: var(--text-light);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .sidebar {
        width: var(--sidebar-width-collapsed);
      }

      .sidebar .logo-text,
      .sidebar .link-text {
        display: none;
      }

      .main-content {
        margin-left: var(--sidebar-width-collapsed);
        padding: 20px;
      }

      .stat-card h3 {
        font-size: 2rem;
      }
    }
  </style>
</head>

<body>

  <div class="sidebar collapsed" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-text fw-bold fs-5"><i class="bi bi-robot"></i> ADMIN</div>
      <button class="toggle-btn" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
      </button>
    </div>

    <a href="#" class="active" title="Dashboard">
      <i class="bi bi-speedometer2"></i>
      <span class="link-text">Dashboard</span>
    </a>
    <a href="/logout" title="Logout">
      <i class="bi bi-box-arrow-right"></i>
      <span class="link-text">Logout</span>
    </a>
  </div>

  <div class="main-content expanded" id="mainContent">

    <div class="d-flex justify-content-between align-items-center mb-5">
      <div>
        <h2 class="fw-bold">Booking Dashboard</h2>
        <p class="text-muted">Manage automated bookings & cancellations</p>
      </div>
      <button onclick="exportToExcel()" class="btn btn-success shadow-sm fw-bold">
        <i class="bi bi-file-earmark-excel-fill me-2"></i> Export Report
      </button>
    </div>

    <div class="row mb-4">
      <div class="col-md-4">
        <div class="stat-card bg-gradient-primary">
          <h3 id="totalCount">0</h3>
          <p>Total Bookings</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card bg-gradient-success">
          <h3 id="activeCount">0</h3>
          <p>Active (Confirmed)</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card bg-gradient-danger">
          <h3 id="cancelledCount">0</h3>
          <p>Cancelled</p>
        </div>
      </div>
    </div>

    <div class="table-card">
      <h5 class="fw-bold mb-4 text-secondary">Reservations List</h5>
      <div class="table-responsive">
        <table class="table table-hover" id="bookingsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Service</th>
              <th>Ref (PNR)</th>
              <th>Travel Date</th>
              <th class="text-center">Price Per Night</th>
              <th class="text-center">Free Cancel Until</th>
              <th class="text-center">Due In</th>
              <th class="text-center">Status</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // --- Sidebar Toggle Logic ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const content = document.getElementById('mainContent');
      sidebar.classList.toggle('collapsed');
      content.classList.toggle('expanded');
    }

    // --- Load Data Logic ---
    async function loadData() {
      try {
        const res = await fetch('/api/admin/bookings');
        const data = await res.json();

        // Update Stats
        document.getElementById('totalCount').innerText = data.length;
        document.getElementById('activeCount').innerText = data.filter(d => d.status === 'Confirmed').length;
        document.getElementById('cancelledCount').innerText = data.filter(d => d.status === 'Cancelled').length;

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        // Sort: Newest first
        data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        data.forEach(item => {
          // 1. Calculate Days Left (Logic for Due In)
          let daysLeftHtml = '<span class="text-muted">-</span>';
          let rowClass = '';
          let isUrgent = false;

          if (item.checkInDate && item.status === 'Confirmed') {
            const checkIn = new Date(item.checkInDate);
            const diffTime = checkIn - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays >= 0) {
              if (diffDays <= 6) {
                isUrgent = true;
                rowClass = 'row-urgent';
                daysLeftHtml = `<span class="badge-urgent">‚ö†Ô∏è ${diffDays} Days</span>`;
              } else {
                daysLeftHtml = `<span class="text-success fw-bold">${diffDays} Days</span>`;
              }
            } else {
              daysLeftHtml = `<span class="text-muted">Passed</span>`;
            }
          }

          // 2. Format Data Fields
          const date = new Date(item.createdAt).toLocaleDateString('en-GB');
          const travelDate = item.checkInDate ? new Date(item.checkInDate).toLocaleDateString('en-GB') : '-';
          const ref = item.pnr || '-';
          const icon = item.serviceType === 'Hotel'
            ? '<i class="bi bi-building text-primary"></i> Hotel'
            : '<i class="bi bi-airplane text-info"></i> Flight';

          // 3. Action Button Logic
          let actionBtn = '';
          if (item.status === 'Confirmed') {
            // Show Resend PDF button for hotel bookings with PNR
            const resendPdfBtn = (item.serviceType === 'Hotel' && item.pnr)
              ? `<button class="btn btn-success btn-sm" onclick="resendPdf('${item._id}', this)" title="Resend PDF confirmation email">
                  <i class="bi bi-envelope-fill"></i> PDF
                </button>`
              : '';

            if (isUrgent) {
              // urgent cancel + delete + resend pdf
              actionBtn = `
                <div class="d-inline-flex gap-2">
                  ${resendPdfBtn}
                  <button class="btn btn-danger btn-sm fw-bold shadow-sm" onclick="cancelBooking('${item._id}', this)">
                    <i class="bi bi-lightning-fill"></i> Cancel Now
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="deleteBooking('${item._id}', this)">Delete</button>
                </div>`;
            } else {
              // normal cancel + delete + resend pdf
              actionBtn = `
                <div class="d-inline-flex gap-2">
                  ${resendPdfBtn}
                  <button class="btn btn-outline-danger btn-sm" onclick="cancelBooking('${item._id}', this)">Cancel</button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="deleteBooking('${item._id}', this)">Delete</button>
                </div>`;
            }
          } else if (item.status === 'Cancelled') {
            actionBtn = `<span class="text-muted small"><i class="bi bi-check2-all"></i> Cancelled</span>`;
          } else {
            // allow delete for archived/pending entries too
            actionBtn = `
              <div class="d-inline-flex gap-2">
                <span class="text-muted small">Archived</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="deleteBooking('${item._id}', this)">Delete</button>
              </div>`;
          }

          // 4. Format Free Cancellation Deadline
          let freeCancelHtml = '<span class="text-muted">-</span>';
          if (item.freeCancellationDeadline && item.status === 'Confirmed') {
            const cancelDeadline = new Date(item.freeCancellationDeadline);
            const now = new Date();
            const hoursUntilDeadline = (cancelDeadline - now) / (1000 * 60 * 60);

            const formattedDate = cancelDeadline.toLocaleDateString('en-GB', {
              day: '2-digit',
              month: 'short',
              year: 'numeric'
            });
            const formattedTime = cancelDeadline.toLocaleTimeString('en-GB', {
              hour: '2-digit',
              minute: '2-digit'
            });

            if (hoursUntilDeadline < 0) {
              // Deadline passed
              freeCancelHtml = `<span class="text-muted small"><i class="bi bi-x-circle"></i> Expired</span>`;
            } else if (hoursUntilDeadline <= 24) {
              // Less than 24 hours - URGENT
              freeCancelHtml = `<span class="badge-urgent"><i class="bi bi-exclamation-triangle-fill"></i> ${formattedDate} ${formattedTime}</span>`;
            } else if (hoursUntilDeadline <= 72) {
              // Less than 3 days - Warning
              freeCancelHtml = `<span class="text-warning fw-bold"><i class="bi bi-clock"></i> ${formattedDate} ${formattedTime}</span>`;
            } else {
              // Safe - more than 3 days
              freeCancelHtml = `<span class="text-success"><i class="bi bi-check-circle"></i> ${formattedDate} ${formattedTime}</span>`;
            }
          }

          // 5. Build Row
          const row = `
            <tr class="${rowClass}">
              <td>${date}</td>
              <td class="fw-bold">${item.clientName}</td>
              <td>${icon}</td>
              <td><code class="text-dark">${ref}</code></td>
              <td>${travelDate}</td>
              <td class="text-center fw-bold">$${item.price || 0}</td>
              <td class="text-center">${freeCancelHtml}</td>
              <td class="text-center">${daysLeftHtml}</td>
              <td class="text-center"><span class="status-badge status-${item.status.split(' ')[0]}">${item.status}</span></td>
              <td class="text-end">${actionBtn}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

      } catch (e) { console.error(e); }
    }

    // --- Cancel Function (Real Bot) ---
    async function cancelBooking(id, btn) {
      if (!confirm('‚ö†Ô∏è ALERT: This will trigger the bot to log in and cancel the booking on Booking.com.\n\nProceed?')) return;

      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Working...';
      btn.disabled = true;

      try {
        const res = await fetch(`/api/admin/cancel/${id}`, { method: 'POST' });
        const result = await res.json();

        if (result.success) {
          alert('‚úÖ Cancellation Successful!');
        } else {
          alert('‚ùå Cancellation Failed: ' + result.error);
        }
      } catch (e) {
        alert('‚ùå Network Error');
      } finally {
        loadData(); // Refresh table
      }
    }

    // --- Delete Function (DB only) ---
    async function deleteBooking(id, btn) {
      if (!confirm('‚ö†Ô∏è This will permanently remove the booking from the database. Proceed?')) return;

      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
      btn.disabled = true;

      try {
        const res = await fetch(`/api/admin/delete/${id}`, { method: 'POST' });
        const result = await res.json();
        if (result.success) {
          alert('‚úÖ Booking deleted.');
        } else {
          alert('‚ùå Delete failed: ' + (result.message || result.error));
        }
      } catch (e) {
        alert('‚ùå Network Error');
      } finally {
        loadData();
      }
    }

    // --- Resend PDF Function ---
    async function resendPdf(id, btn) {
      if (!confirm('üìß This will download the PDF from Booking.com and send it to the client email.\n\nProceed?')) return;

      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
      btn.disabled = true;

      try {
        const res = await fetch(`/api/admin/resend-pdf/${id}`, { method: 'POST' });
        const result = await res.json();

        if (result.success) {
          alert('‚úÖ PDF sent successfully!');
        } else {
          alert('‚ùå Failed: ' + (result.message || result.error));
        }
      } catch (e) {
        alert('‚ùå Network Error');
      } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
      }
    }

    // --- Export Excel ---
    function exportToExcel() {
      const table = document.getElementById("bookingsTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Bookings" });
      XLSX.writeFile(wb, "Bookings_Report.xlsx");
    }

    // Init
    loadData();
    setInterval(loadData, 5000);
  </script>
</body>

</html>